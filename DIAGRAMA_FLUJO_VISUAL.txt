
╔══════════════════════════════════════════════════════════════════════════════╗
║                    COSMOS AI - DIAGRAMA DE FLUJO COMPLETO                     ║
║                         System Architecture v3.0                              ║
╚══════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│                          [1] DATA INGESTION LAYER                            │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
    │   Binance    │     │   Helius     │     │  Alternative │
    │   CCXT API   │     │   RPC API    │     │     .me      │
    │              │     │              │     │              │
    │ • OHLCV      │     │ • Whale Txs  │     │ • Fear/Greed │
    │ • Order Book │     │ • SOL Flow   │     │   Index      │
    └──────┬───────┘     └──────┬───────┘     └──────┬───────┘
           │                    │                    │
           └────────────────────┼────────────────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │   binance_engine.py   │
                    │   whales_monitor.py   │
                    │   macro_feed.py       │
                    └───────────┬───────────┘
                                │
                                ▼

┌─────────────────────────────────────────────────────────────────────────────┐
│                      [2] FEATURE ENGINEERING LAYER                           │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌───────────────────────┐
                    │    scanner.py         │
                    │                       │
                    │  • RSI (14)           │
                    │  • MACD (12,26,9)     │
                    │  • EMA (200)          │
                    │  • ATR (14)           │
                    │  • Order Book Imb.    │
                    │  • Volume Pressure    │
                    │  • Market Structure   │
                    └───────────┬───────────┘
                                │
                                ▼

┌─────────────────────────────────────────────────────────────────────────────┐
│                        [3] AI DECISION ENGINE                                │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌───────────────────────┐
                    │  cosmos_engine.py     │
                    │  (CosmosBrain)        │
                    └───────────┬───────────┘
                                │
                ┌───────────────┼───────────────┐
                │               │               │
                ▼               ▼               ▼
    ┌──────────────────┐ ┌──────────────┐ ┌──────────────────┐
    │ Random Forest    │ │  XGBoost     │ │  GPT-5 Nano      │
    │ Classifier       │ │  (Deep)      │ │  (Narrative)     │
    │                  │ │              │ │                  │
    │ • 100 Trees      │ │ • Temporal   │ │ • Reasoning      │
    │ • Max Depth: 5   │ │   Sequences  │ │ • Context        │
    │ • Features: 6    │ │ • Lookback:  │ │ • Confidence     │
    │                  │ │   12 periods │ │   Explanation    │
    └──────────────────┘ └──────────────┘ └──────────────────┘
                │               │               │
                └───────────────┼───────────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │   Probability Score   │
                    │   (0.0 to 1.0)        │
                    └───────────┬───────────┘
                                │
                                ▼

┌─────────────────────────────────────────────────────────────────────────────┐
│                     [4] VALIDATION PIPELINE                                  │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌───────────────────────┐
                    │  cosmos_validator.py  │
                    │  (PhD Layer)          │
                    └───────────┬───────────┘
                                │
                ┌───────────────┼───────────────┐
                │               │               │
                ▼               ▼               ▼
    ┌──────────────────┐ ┌──────────────┐ ┌──────────────────┐
    │ Academic RAG     │ │  VPIN        │ │  Kelly Criterion │
    │ (rag_engine_v2)  │ │  Toxicity    │ │  Position Size   │
    │                  │ │              │ │                  │
    │ • Vector Search  │ │ • Flow       │ │ • Win Rate       │
    │ • 3072 dims      │ │   Analysis   │ │ • Risk/Reward    │
    │ • P-Value < 0.05 │ │ • Threshold  │ │ • Half Kelly     │
    │ • MIT/Harvard/   │ │   > 0.6      │ │                  │
    │   Oxford Papers  │ │              │ │                  │
    └──────────────────┘ └──────────────┘ └──────────────────┘
                │               │               │
                └───────────────┼───────────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │   Validation Result   │
                    │   • Approved: bool    │
                    │   • P-Value: float    │
                    │   • Thesis ID: int    │
                    │   • University: str   │
                    └───────────┬───────────┘
                                │
                                ▼

┌─────────────────────────────────────────────────────────────────────────────┐
│                      [5] MULTI-LAYER FILTERS                                 │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌───────────────────────┐
                    │   Filter Pipeline     │
                    └───────────┬───────────┘
                                │
                ┌───────────────┼───────────────┬───────────────┐
                │               │               │               │
                ▼               ▼               ▼               ▼
    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
    │ Trend        │ │ Volume       │ │ Liquidity    │ │ H4 S/R       │
    │ Alignment    │ │ Filter       │ │ Depth        │ │ Proximity    │
    │              │ │              │ │              │ │              │
    │ 5m vs 15m    │ │ >0.95x MA    │ │ >$50k depth  │ │ <0.5% away   │
    │ EMA Check    │ │              │ │ (Redis)      │ │              │
    └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘
                │               │               │               │
                └───────────────┼───────────────┴───────────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │   PASS / REJECT       │
                    └───────────┬───────────┘
                                │
                                ▼

┌─────────────────────────────────────────────────────────────────────────────┐
│                      [6] CIRCUIT BREAKER (NEW)                               │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌───────────────────────┐
                    │  circuit_breaker.py   │
                    └───────────┬───────────┘
                                │
                ┌───────────────┼───────────────┐
                │               │               │
                ▼               ▼               ▼
    ┌──────────────────┐ ┌──────────────┐ ┌──────────────────┐
    │ Daily Loss       │ │ Consecutive  │ │ Max Drawdown     │
    │ Limit            │ │ Losses       │ │ Limit            │
    │                  │ │              │ │                  │
    │ Max: 5%          │ │ Max: 5       │ │ Max: 10%         │
    │ of Capital       │ │ Trades       │ │ from Peak        │
    └──────────────────┘ └──────────────┘ └──────────────────┘
                │               │               │
                └───────────────┼───────────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │   ALLOW / HALT        │
                    └───────────┬───────────┘
                                │
                                ▼

┌─────────────────────────────────────────────────────────────────────────────┐
│                        [7] SIGNAL GENERATION                                 │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌───────────────────────┐
                    │   db.py               │
                    │   insert_signal()     │
                    └───────────┬───────────┘
                                │
                ┌───────────────┼───────────────┐
                │               │               │
                ▼               ▼               ▼
    ┌──────────────────┐ ┌──────────────┐ ┌──────────────────┐
    │ Supabase         │ │ Redis        │ │ Pusher           │
    │ (Persistent)     │ │ (Cache)      │ │ (Real-time)      │
    │                  │ │              │ │                  │
    │ • signals table  │ │ • Price      │ │ • public-signals │
    │ • RLS policies   │ │ • Liquidity  │ │ • private-vip    │
    │ • Realtime sub   │ │ • <10ms      │ │ • WebSocket      │
    └──────────────────┘ └──────────────┘ └──────────────────┘
                │               │               │
                └───────────────┼───────────────┘
                                │
                                ▼

┌─────────────────────────────────────────────────────────────────────────────┐
│                        [8] EXECUTION LAYER                                   │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌───────────────────────┐
                    │   Execution Router    │
                    └───────────┬───────────┘
                                │
                ┌───────────────┼───────────────┐
                │               │               │
                ▼               ▼               ▼
    ┌──────────────────┐ ┌──────────────┐ ┌──────────────────┐
    │ Paper Trader     │ │ Nexus        │ │ One-Click        │
    │ (Simulated)      │ │ Executor     │ │ Trade Modal      │
    │                  │ │ (Live)       │ │ (Manual)         │
    │ • Virtual $10k   │ │ • Binance    │ │ • User Trigger   │
    │ • Risk-Free      │ │ • Hyperliquid│ │ • Confirmation   │
    │ • Learning       │ │ • Slippage   │ │ • Custom Size    │
    └──────────────────┘ └──────────────┘ └──────────────────┘
                │               │               │
                └───────────────┼───────────────┘
                                │
                                ▼

┌─────────────────────────────────────────────────────────────────────────────┐
│                      [9] MONITORING & FEEDBACK                               │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌───────────────────────┐
                    │  cosmos_auditor.py    │
                    │  (Real-time Updates)  │
                    └───────────┬───────────┘
                                │
                ┌───────────────┼───────────────┐
                │               │               │
                ▼               ▼               ▼
    ┌──────────────────┐ ┌──────────────┐ ┌──────────────────┐
    │ Signal Updates   │ │ Recursive    │ │ Performance      │
    │                  │ │ Learning     │ │ Analytics        │
    │ • TP Tighten     │ │              │ │                  │
    │ • SL Adjust      │ │ • Asset Bias │ │ • Win Rate       │
    │ • Risk-Free      │ │ • Win Rate   │ │ • Sharpe Ratio   │
    │ • Warning        │ │ • Multiplier │ │ • Max Drawdown   │
    └──────────────────┘ └──────────────┘ └──────────────────┘
                │               │               │
                └───────────────┼───────────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │   Feedback Loop       │
                    │   (Retrain Model)     │
                    └───────────┬───────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │   cosmos_engine.py    │
                    │   train()             │
                    └───────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                        [10] USER INTERFACE                                   │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌───────────────────────┐
                    │   Next.js Dashboard   │
                    │   (src/app/dashboard) │
                    └───────────┬───────────┘
                                │
                ┌───────────────┼───────────────┬───────────────┐
                │               │               │               │
                ▼               ▼               ▼               ▼
    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
    │ Signal Cards │ │ TradingView  │ │ Performance  │ │ VIP Paywall  │
    │              │ │ Charts       │ │ Stats        │ │              │
    │ • Real-time  │ │              │ │              │ │ • Supabase   │
    │ • Confidence │ │ • SmartChart │ │ • Win Rate   │ │   Auth       │
    │ • TP/SL      │ │ • Indicators │ │ • PnL        │ │ • Profiles   │
    │ • PhD Badge  │ │ • Drawings   │ │ • Sharpe     │ │ • Stripe     │
    └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘

╔══════════════════════════════════════════════════════════════════════════════╗
║                           LATENCY BENCHMARKS                                  ║
╠══════════════════════════════════════════════════════════════════════════════╣
║  Data Ingestion:        50-100ms  (Binance API)                              ║
║  Feature Engineering:   20-30ms   (Technical Indicators)                     ║
║  AI Prediction:         10-15ms   (Random Forest)                            ║
║  Academic Validation:   100-200ms (Vector Search)                            ║
║  Signal Generation:     5-10ms    (DB Insert)                                ║
║  Real-time Broadcast:   <10ms     (Redis + Pusher)                           ║
║  ─────────────────────────────────────────────────────────────────────────── ║
║  TOTAL END-TO-END:      185-365ms (Average: 275ms)                           ║
╚══════════════════════════════════════════════════════════════════════════════╝

╔══════════════════════════════════════════════════════════════════════════════╗
║                           CRITICAL PATHS                                      ║
╠══════════════════════════════════════════════════════════════════════════════╣
║  1. cosmos_worker.py → scanner.py → cosmos_engine.py → db.py                 ║
║  2. cosmos_oracle.py → cosmos_engine.py → db.py → pusher_client.py           ║
║  3. paper_trader.py → cosmos_auditor.py → db.py → pusher_client.py           ║
╚══════════════════════════════════════════════════════════════════════════════╝

╔══════════════════════════════════════════════════════════════════════════════╗
║                           FAILURE POINTS                                      ║
╠══════════════════════════════════════════════════════════════════════════════╣
║  ❌ whale_monitor scope (CRITICAL - Fixed in FIXES_CRITICOS_IMPLEMENTACION)  ║
║  ⚠️  Academic validation bypass (IMPORTANT - Fixed)                          ║
║  ❌ No Circuit Breaker (CRITICAL - Implemented)                              ║
║  ⚠️  VPIN simplified (IMPORTANT - Corrected)                                 ║
╚══════════════════════════════════════════════════════════════════════════════╝

═══════════════════════════════════════════════════════════════════════════════
                            END OF DIAGRAM
═══════════════════════════════════════════════════════════════════════════════
